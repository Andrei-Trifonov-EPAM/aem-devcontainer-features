#!/usr/bin/env bash

usage() {
    cat <<EOM
Usage: $(basename $0) <runmode_primary> <runmode_secondary>
where
  <runmode_primary> is 'author' or 'publish'. ('author' is default)
  <runmode_secondary> is string like 'local' or 'dev' etc (optional)
EOM
    exit 1
}

runmode_primary="${1:-author}" # default = "start"
runmode_secondary="${2}"       # default = ""

case "$runmode_primary" in author | publish)
    # Valid, do nothing
    ;;
*)
    echo "Error: Invalid runmode_primary: '$runmode_primary'"
    usage
    exit 1
    ;;
esac

jar="${AEM_SDK_FEATURE_DIR}/${runmode_primary}/$(get_runmode_jar ${runmode_primary} ${runmode_secondary})"

if [[ ! -f ${jar} ]]; then
    # install it
    $(dirname $0)/aem-sdk-setup-service.sh ${runmode_primary} || exit
fi

# run it
port=$(get_runmode_port ${runmode_primary})
jvm_opts="-agentlib:jdwp=transport=dt_socket,address=*:3${port},server=y,suspend=n"
cq_opts="-nofork -nobrowser -nointeractive"
cd "$(dirname ${jar})"
java ${jvm_opts} -jar ${jar} ${cq_opts}
